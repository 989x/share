# ลำดับการตรวจสอบความพร้อมของระบบจอง (Booking Availability Priority)

เอกสารฉบับอ่านง่ายสำหรับทีม UX/UI อธิบายว่า **ก่อนจะแสดงปุ่ม “จอง”** ระบบต้องเช็กอะไรบ้างและเช็กตามลำดับใด เพื่อกำหนดสถานะของแต่ละ **รอบเวลา** ให้เป็น **ว่าง / กันไว้ชั่วคราว / ถูกจองแล้ว**
นอกจากนี้ยังมี **กติกากลุ่ม** สำหรับบริการที่ใช้เวลา **60 นาที** อยู่ 3 แบบที่มีผลต่อจำนวนรับได้ในแต่ละรอบ:

- **ห้องเดี่ยว (exclusive_room):** ต่อรอบทั้งกลุ่มรับได้ **1 เคส** เท่านั้น
- **ล็อกชนิดต่อรอบ (exclusive_pool):** ต่อรอบมีโควตรวม แต่ต้องเป็น **บริการชนิดเดียวกัน** (มี “เจ้าของรอบ”)
- **แชร์โควตาต่อรอบ (shared_pool):** ต่อรอบมีโควตรวม และ **ผสมหลายบริการ** ในรอบเดียวกันได้

> ถ้าไม่ใช่บริการ 60 นาที ให้ใช้โควตาของบริการย่อยนั้นตามปกติ

## ลำดับการทำงาน

1. **ตรวจสอบข้อมูลที่ผู้ใช้ส่งมา**

   - ผู้ใช้ต้องเลือก “บริการย่อย” (หรือ “บริการหลัก” ในหน้าค้นหาตามวัน) และ “วันที่ต้องการจอง” ที่ระบุได้ชัดเจน
   - หากไม่ครบหรือรูปแบบไม่ถูกต้อง ให้แจ้งข้อผิดพลาดทันที

2. **ตรวจสอบสถานะการใช้งาน**

   - ตรวจว่า “ร้าน”, “บริการหลัก”, และ “บริการย่อย” ยังเปิดใช้งานอยู่ทั้งหมด
   - หากรายการใดถูกปิดใช้งาน ให้ยุติกระบวนการจองของวันนั้น

3. **ตรวจสอบวันหยุดเต็มวัน**

   - ถ้าวันนั้นร้านปิดทั้งวัน → แสดงข้อความ **“วันนี้ร้านไม่เปิดให้บริการ”**
   - ถ้าวันนั้นบริการย่อยปิดทั้งวัน → แสดงข้อความ **“วันนี้บริการนี้ไม่เปิดให้จอง”**

4. **สร้างตารางรอบเวลาที่เปิดให้จอง**

   - สร้างรายการเวลาเริ่มต้น (เช่น 09:00, 10:00, …) ตามช่วงเวลาที่บริการย่อยกำหนด โดยใช้ “ระยะเวลาบริการ” เป็นช่วงก้าว (เช่น 60 นาที) และนับแบบ **สิ้นสุดไม่รวมปลายช่วง**

   > ตัวอย่าง: เปิด 09:00–18:00, ใช้เวลา 60 นาที → รอบเวลา: 09:00, 10:00, …, 17:00

5. **ปรับรอบเวลาให้สอดคล้องกับช่วงให้บริการจริงของร้านและช่วงปิดบางช่วง**

   - **กรองรอบเวลาให้เหลือเฉพาะช่วงที่ร้าน “เปิดให้บริการ”** ตาม `store_time_blocks`
   - **ลบรอบเวลาที่ซ้อนทับกับ “ช่วงปิดบางช่วง” (Partial Holiday)** ของร้านหรือบริการย่อย
   - หากหลังกรอง/ลบแล้ว **ไม่เหลือรอบเวลา** ให้แสดง **“วันนี้ไม่มีรอบให้จอง”**

6. **ตรวจสอบกติกากลุ่ม (เฉพาะบริการ 60 นาที)**

   - **ห้องเดี่ยว:** ต่อรอบทั้งกลุ่มรับได้ **1 เคส**
   - **ล็อกชนิดต่อรอบ:** ต่อรอบมีโควตรวม แต่ต้องเป็น **บริการชนิดเดียวกัน** (มี “เจ้าของรอบ”)
   - **แชร์โควตาต่อรอบ:** ต่อรอบมีโควตรวม และ **ผสมหลายบริการ** ได้

7. **เลือกระบบกติกาที่มีผล (เลือกตัวที่เข้มงวดที่สุดก่อน)**

   - ลำดับความเข้มงวด: **ห้องเดี่ยว → ล็อกชนิดต่อรอบ → แชร์โควตาต่อรอบ**
   - จากนั้นคำนวณ **จำนวนรับได้สูงสุดต่อรอบ** ของบริการย่อยนั้น = ค่าน้อยสุดระหว่าง “โควตากลุ่มต่อรอบ” กับ “โควตาของบริการย่อย”

   > ตัวอย่าง: กลุ่มตั้งไว้ 5 แต่บริการย่อยตั้งไว้ 2 ⇒ บริการย่อยนี้รับได้สูงสุด **2 คนต่อรอบ**

8. **รวมจำนวนการใช้งานในแต่ละรอบเวลา**

   คิดยอด **ถูกจองแล้ว** (การจองจริงที่ยืนยันแล้วหรืออยู่ระหว่างดำเนินการ) และยอด **กันไว้ชั่วคราว** (กำลังทำรายการและยังไม่หมดอายุ)

   - ถ้ามีกติกากลุ่มและเป็นบริการ 60 นาที: รวมยอดจาก **ทุกบริการย่อย 60 นาที** ในกลุ่มเดียวกัน
   - ถ้าไม่เข้าเงื่อนไขกติกากลุ่ม: รวมเฉพาะยอดของบริการย่อยนั้น

9. **กติกาเฉพาะ “ล็อกชนิดต่อรอบ” (หาเจ้าของรอบ)**

   ในแต่ละเวลา:

   - ถ้ามี **บริการชนิดเดียว** ที่มีการจองจริง > 0 ⇒ เป็น **เจ้าของรอบ**
   - ถ้ายังไม่มีการจองจริง แต่มี **บริการชนิดเดียว** ที่ถูกกันไว้ชั่วคราว > 0 ⇒ เป็น **เจ้าของชั่วคราว**
   - อื่น ๆ ⇒ **ไม่มีเจ้าของ**; บริการอื่นในกลุ่มจะเห็นรอบนั้นเป็น **กันไว้ชั่วคราว** หรือ **ถูกจองแล้ว** ตามยอดรวม และ **กดเลือกไม่ได้**

10. **กำหนดสถานะรอบเวลา (สิ่งที่ผู้ใช้เห็น)**

    วิธีตัดสินสถานะของรอบเวลา:

    1. ถ้าจำนวน **จองแล้ว** ถึงหรือเกินโควตา ⇒ รอบนั้น **ถูกจองแล้ว**
    2. ถ้ายังไม่ถึงข้อ 1 แต่จำนวน **จองแล้ว + กันคิวไว้** ถึงหรือเกินโควตา ⇒ รอบนั้น **กันไว้ชั่วคราว**
    3. ถ้ายังไม่ถึงทั้งสองข้อ ⇒ รอบนั้น **ว่าง**

    ตัวอย่าง(โควตา = 5)

    1. จองแล้ว 5, กันคิว 0 ⇒ **ถูกจองแล้ว**
    2. จองแล้ว 3, กันคิว 2 ⇒ **กันไว้ชั่วคราว**
    3. จองแล้ว 2, กันคิว 1 ⇒ **ว่าง**

11. **กันสิทธิ์ชั่วคราวและยืนยันการจอง**
    - เมื่อผู้ใช้กดเลือกเวลา ระบบจะ **กันไว้ชั่วคราว** พร้อมตั้งเวลาหมดอายุ
    - หากผู้ใช้ ยืนยันการจอง ภายในเวลาที่กำหนด ระบบจะตรวจอีกรอบว่ารอบนั้นยังว่างพอ แล้วเปลี่ยนเป็น **ถูกจองแล้ว**
    - หากผู้ใช้ไม่ยืนยันทันเวลา การกันไว้ชั่วคราวจะหมดอายุ รอบเวลานั้นจะกลับไปเป็น ว่าง (หรือเป็น กันไว้ชั่วคราว ตามสถานการณ์ล่าสุด) และผู้อื่นสามารถเลือกได้อีกครั้ง

## สรุป

- คิดภาพง่าย ๆ: ระบบไล่เช็กจาก **ข้อมูลที่ผู้ใช้เลือก → สถานะเปิดใช้งาน → วันหยุด → ตารางรอบเวลา → เวลาเปิด–ปิดร้าน → วันหยุดบางช่วง → กติกากลุ่ม (เฉพาะ 60 นาที) → ยอดใช้งาน ณ รอบนั้น** แล้วจึงตัดสินว่า **ว่าง / กันไว้ชั่วคราว / ถูกจองแล้ว**
- ใช้คำสื่อสารบนหน้าให้เข้าใจทันที เช่น **“วันนี้ร้านไม่เปิดให้บริการ”**, **“วันนี้บริการนี้ไม่เปิดให้จอง”**, หรือ **“วันนี้ไม่มีรอบให้จอง”** ตามกรณี
- แนะนำให้แสดงตัวนับแบบ **ใช้ไป / รับได้สูงสุด** ข้างแต่ละรอบ (เช่น `3/5`) เพื่อให้ผู้ใช้เห็นภาพความหนาแน่นของรอบอย่างรวดเร็ว
- สำหรับ “ล็อกชนิดต่อรอบ” ให้บอกผู้ใช้ชัดเจนว่ารอบเวลานี้ถูก “ยึด” โดยบริการชนิดหนึ่งชั่วคราวหรือถาวรแล้ว เพื่อหลีกเลี่ยงความสับสนเวลารอบขึ้นเป็น **กันไว้ชั่วคราว** ทั้งที่ยังไม่เต็มจำนวน
