# ขั้นตอนการตั้งค่าเงื่อนไขการจอง (StoreCondition) — ฉบับย่อสำหรับ UX/UI

## ทำไมต้องมี StoreCondition + กฎใช้งาน

- หลายบริการต้อง **แชร์ทรัพยากรจริง** (ห้อง/เตียง/เครื่องมือ) จึงต้องกำหนด **โควตาต่อรอบ** ให้สะท้อนของจริงในหน้า Availability
- **ประเภทเงื่อนไข (ชื่อบน UI)**

  - **ห้องเดี่ยว** _(exclusive_room)_: 1 การจองต่อรอบทั้งกลุ่ม
  - **ล็อกชนิดต่อรอบ** _(exclusive_pool)_: มีโควตรวมต่อรอบ แต่รอบนั้นเป็นของ **บริการชนิดเดียว** (มี “เจ้าของรอบ”)
  - **แชร์โควตาต่อรอบ** _(shared_pool)_: มีโควตรวมต่อรอบ หลายบริการใช้ร่วมกันได้

- **ใช้กับบริการ 60 นาทีเท่านั้น** (`duration_minutes = 60`) บริการระยะเวลาอื่นจะ **ไม่เข้ากลุ่มอัตโนมัติ** และใช้โควตาของตัวเอง
- **ลำดับความเข้มงวด**: ห้องเดี่ยว → ล็อกชนิดต่อรอบ → แชร์โควตาต่อรอบ (ถ้าทับซ้อนให้ใช้ตัวที่เข้มงวดกว่า)
- **โควตาที่มีผลจริง (effective capacity)** = `min(โควตากลุ่มต่อรอบ, โควตาของบริการนั้น)`
- **เจ้าของรอบ (เฉพาะล็อกชนิดต่อรอบ)**: ในแต่ละรอบมีได้เพียง 1 ชนิดบริการ
  ถ้ามี Booked ของชนิดเดียว → ชนิดนั้นเป็นเจ้าของ, ถ้าไม่มี Booked แต่มี `User กำลังเลือกอยู่` ชนิดเดียว → เจ้าของชั่วคราว

## ลำดับการตั้งค่า (Flow Admin) — เริ่มจากหน้าร้าน

กำหนดให้ตอนนี้อยู่ในหน้า การตั้งค่าเงื่อนไขการจอง (StoreCondition) ของร้านที่เลือกแล้ว

1. **ตั้งชื่อ Group Key** *(แนะนำให้บังคับกรอก)*
   ใช้ชื่อที่คนหน้างานเข้าใจ เช่น “ห้องนวด A”, “เตียง 2”, “ห้องตรวจ 1” (ควร **unique** ภายในร้าน)

2. **หยิบ Service ทีละอันเพิ่มเข้ากลุ่ม (Add/Chip)**
   เลือกได้หลายบริการในร้านเดียวกัน — ครอบคลุม **ทุก sub-service ของบริการนั้น** แต่มีผลจริงเฉพาะ **sub-service 60 นาที**
   *Tip:* โชว์ตัวอย่าง/จำนวน sub-service 60 นาทีที่จะได้รับผล และเตือนถ้าไม่พบรายการ 60 นาทีเลย

3. **เลือกประเภทเงื่อนไข**: **ห้องเดี่ยว** / **ล็อกชนิดต่อรอบ** / **แชร์โควตาต่อรอบ**

   * **ห้องเดี่ยว**: 1 เคส/รอบ ทั้งกลุ่ม
   * **ล็อกชนิดต่อรอบ**: มีโควตรวม แต่หนึ่งรอบอนุญาต **ชนิดเดียว** (มี “เจ้าของรอบ”)
   * **แชร์โควตาต่อรอบ**: มีโควตรวมต่อรอบ และ **ผสมหลายบริการ** ในรอบเดียวกันได้
     *ถ้าทับซ้อนกับเงื่อนไขเดิม ให้แจ้งว่า “ระบบจะใช้กติกาที่เข้มงวดกว่าโดยอัตโนมัติ” (ลำดับ: ห้องเดี่ยว → ล็อกชนิดต่อรอบ → แชร์โควตาต่อรอบ)*

4. **กำหนดโควตาต่อรอบ** *(เฉพาะ “ล็อกชนิดต่อรอบ/แชร์โควตาต่อรอบ”)*
   ใส่จำนวนเต็ม ≥ 1 (มี validation) และอธิบายสั้นๆ ว่า **โควตาที่มีผลจริง** = `min(โควตากลุ่มต่อรอบ, max_booking_per_slot ของบริการ)`
   *ตัวอย่าง:* ถ้า `max_booking_per_slot = 2` แม้กลุ่มกำหนด 5 ก็ใช้ได้สูงสุด **2 ต่อรอบ** สำหรับบริการนั้น

5. **บันทึก (Save/Confirm)**
   แสดงหน้าสรุป: ร้าน, Group Key, รายการบริการ, ประเภท, โควตา (ถ้ามี), และ **จำนวน sub-service 60 นาทีที่จะได้รับผล**
   บันทึกแล้วแสดง Toast “บันทึกสำเร็จ” และแจ้งว่า **หน้า Availability ฝั่งลูกค้าจะอัปเดตอัตโนมัติ** (สถานะแสดงเป็น **ว่าง / กันไว้-ถือสิทธิ์ชั่วคราว / เต็ม**)
   ในรายการเงื่อนไขมีปุ่ม **Edit / Disable** สำหรับปรับแก้ภายหลัง


## ตัวอย่างการตั้งค่าที่สมจริง

**อธิบายสถานะ**

- `available` → **ว่าง**
- `held` → **กันไว้ หรือ ถือสิทธิ์ชั่วคราว** กรณีมีคนกำลังเลือกอยู่ แต่ยังไงม่ Login เพื่อยืนยันตัว
- `booked` → **เต็ม หรือ ถูกจองแล้ว**

1. **สปา (สาขาสยาม) — ห้องนวดส่วนตัว**

   - บริการ: นวดไทย 60, นวดอโรม่า 60
   - ประเภท: **ห้องเดี่ยว**
   - ผล: รอบเดียวกันจองได้เพียง **1 เคส** ไม่ว่ามาจากบริการใดในกลุ่ม

2. **คลินิกกายภาพ (เชียงใหม่) — เครื่องกายภาพ 2 เครื่อง**

   - บริการ: Therapy A 60, Therapy B 60
   - ประเภท: **ล็อกชนิดต่อรอบ** + โควตาต่อรอบ = 2
   - ผล: ต่อรอบเปิดได้ 2 เคส แต่ **ต้องเป็นชนิดเดียวกัน** ถ้า A เริ่มใช้งาน รอบนั้นเป็นของ A; B จะเห็นเป็น `held`/`booked` ตามโควตรวม

3. **คลินิกผิวหนัง (สุขุมวิท) — เตียง 5 เตียง**

   - บริการ: เลเซอร์ 60, โฟโตน 60, มาส์ก 60
   - ประเภท: **แชร์โควตาต่อรอบ** + โควตาต่อรอบ = 5
   - ผล: ต่อรอบผสมหลายบริการได้ รวมกันไม่เกิน 5 และแสดง `available/held/booked` ตามยอดจองและโควตรวม
